/* exported Touch__initClick */
function Touch__initClick($container, force) {
    var timeout = 200,
        isScrolling = false,
        maxDistance = 10,
        startTime = 0,
        lastTime = 0,
        startX,
        startY;

    $container = $container || document;

    // 新版本的android客户端默认快速点击
    if (Utils__isChromium() && !Utils__isIOS()) {
        return;
    }

    Dom__on($container, 'touchstart', function(e) {
        var touches = e.touches,
            touch = touches[0];

        if (touches.length > 1) {
            return;
        }

        startTime = e.timeStamp;
        startX = touch.pageX;
        startY = touch.pageY;

        if (startTime - lastTime < timeout) { // prevent double click
            startTime = 0;
        }
    });

    Dom__on($container, 'touchend', function(e) {
        var touch = e.changedTouches[0],
            MIN_SCROLL_ANGLE = 60,
            abs = Math.abs;

        var moveX = abs(touch.pageX - startX);
        var moveY = abs(touch.pageY - startY);
        if (moveX > maxDistance || moveY > maxDistance) {
            // 横滑不会触发 scroll 事件
            var moveAngle = moveY / (moveX || 1) * 100;
            if (Math.abs(moveAngle) >= MIN_SCROLL_ANGLE) {
                isScrolling = true;
            }
            return;
        }

        if (isScrolling || e.timeStamp - startTime > timeout) {
            isScrolling = false;
            return;
        }

        Dom__trigger(e.target, 'click');
        lastTime = e.timeStamp;
    });

    // IOS webview 只会在滚动结束之后触发 scroll 事件，后于 touchend
    // 完整滚动的事件流 touchstart -> touchend -> scroll
    Dom__on($container, 'scroll', function() {
        isScrolling = false;
    });

    Dom__on($container, 'click', function(e) {
        if (e.which) {  // e.which == 1 when triggered by touching
            e.preventDefault();
            e.stopImmediatePropagation();
        }
    }, true);
}

/* exported Touch__initHold */
function Touch__initHold($container) {
    var timeout = 500,
        triggered,
        timer;

    $container = $container || document;

    Dom__on($container, 'touchstart', function(e) {
        var $target = e.target;

        if (e.touches.length > 1) return cancel();;

        timer = setTimeout(function() {
            triggered = 1;
            Dom__trigger($target, 'hold');
        }, timeout);
    });

    function cancel(e) {
        if (timer) {
            clearTimeout(timer);
            timer = 0;
        }
        // IOS下，当长按出浮层时，会触发浮层的click
        // 理想情况是在trigger hold之后，其它的事件都会被屏蔽
        if (triggered) {
            triggered = 0;
            e && e.preventDefault();
        }
    }

    Dom__on($container, 'touchmove', cancel);
    Dom__on($container, 'touchcancel', cancel);
    Dom__on($container, 'touchend', cancel);
}
